<!--
–î–ï–ü–õ–û–ô –ù–ê GITHUB PAGES:
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub.
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª `index.html` –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
3. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (`Settings`), –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª `Pages`.
4. –í —Å–µ–∫—Ü–∏–∏ `Build and deployment`, –≤—ã–±–µ—Ä–∏—Ç–µ `Source` -> `Deploy from a branch`.
5. –í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ç–∫—É (`main` –∏–ª–∏ `master`) –∏ –ø–∞–ø–∫—É (`/root`). –ù–∞–∂–º–∏—Ç–µ `Save`.
6. –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É `https://<–≤–∞—à-—é–∑–µ—Ä–Ω–µ–π–º>.github.io/<–∏–º—è-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è>/`.
-->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöó</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      /* Custom scrollbar for a cleaner look in webkit browsers */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f3f4f6; /* bg-gray-100 */
      }
      ::-webkit-scrollbar-thumb {
        background: #9ca3af; /* bg-gray-400 */
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280; /* bg-gray-500 */
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;  
        overflow: hidden;
      }
      .hidden {
        display: none;
      }
      /* 
        –¶–µ–ª–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –µ–¥–∏–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–∞—Ö.
        –≠—Ç–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è <select> –∏ <option>.
      */
      html, body {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      }
      select, option {
        font-family: inherit !important;
      }
      /* Animation for grid layout changes */
      #content-area > .grid {
        transition: grid-template-columns 0.4s ease-in-out;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
</head>
<body class="bg-gray-100">

<div class="min-h-screen text-gray-900">
    <div class="container mx-auto px-4 sm:px-6 py-8">
        <header class="flex justify-between items-center mb-6">
            <div class="text-gray-900">
                <svg width="99" height="27" viewBox="0 0 99 27" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_117_213)"><path d="M72.67 3.82V0H51.52V3.82H60.44V18.13H64.25V3.82H72.67Z" fill="currentColor"/><path d="M98.4298 18.13V14.32H81.0898V10.97H90.4598V7.56H81.0898V3.82H98.4298V0H77.2798V18.13H98.4298Z" fill="currentColor"/><path d="M21.15 18.13V7.61H7.97V10.97H17.34V14.77H3.82V3.82H21.15V0H0V18.13H21.15Z" fill="currentColor"/><path d="M29.5698 18.13V10.97H43.0898V18.13H46.9098V0H25.7598V18.13H29.5798H29.5698ZM29.5698 7.56V3.81H43.0898V7.56H29.5698Z" fill="currentColor"/><path d="M62.09 24.8401H0V25.5501H62.09V24.8401Z" fill="currentColor"/><path d="M68.5902 24.03H68.5802C68.3102 23.66 67.9602 23.48 67.5302 23.48C67.0602 23.48 66.6802 23.64 66.3902 23.95C66.1002 24.27 65.9502 24.66 65.9502 25.14C65.9502 25.62 66.1002 26.02 66.3902 26.34C66.6802 26.66 67.0702 26.81 67.5302 26.81C67.9502 26.81 68.3002 26.62 68.5802 26.25H68.5902V26.71H69.3602V23.56H68.5902V24.02V24.03ZM68.3302 25.83C68.1602 26.02 67.9402 26.11 67.6702 26.11C67.4002 26.11 67.1902 26.02 67.0102 25.83C66.8402 25.64 66.7502 25.41 66.7502 25.15C66.7502 24.89 66.8402 24.67 67.0102 24.47C67.1802 24.28 67.4002 24.19 67.6702 24.19C67.9402 24.19 68.1502 24.28 68.3302 24.47C68.5002 24.66 68.5902 24.89 68.5902 25.15C68.5902 25.41 68.5002 25.64 68.3302 25.83Z" fill="currentColor"/><path d="M72.1703 25.4101C72.1703 25.6101 72.1003 25.7701 71.9703 25.9101C71.8403 26.0401 71.6703 26.1101 71.4803 26.1101C71.2903 26.1101 71.1303 26.0401 71.0003 25.9101C70.8703 25.7801 70.8003 25.6101 70.8003 25.4101V23.5701H70.0303V25.4801C70.0303 25.8701 70.1403 26.2001 70.3703 26.4501C70.6003 26.7001 70.8903 26.8201 71.2603 26.8201C71.4803 26.8201 71.6803 26.7701 71.8503 26.6701C72.0203 26.5701 72.1503 26.4401 72.2403 26.2701H72.2503V26.7201H72.9603V23.5701H72.1903V25.4101H72.1703Z" fill="currentColor"/><path d="M74.4702 22.8601H73.7001V23.5701H73.4102V24.1701H73.7001V25.7901C73.7001 26.0701 73.7902 26.3001 73.9602 26.4701C74.1402 26.6401 74.3702 26.7201 74.6502 26.7201H75.0002V26.0301H74.6502C74.6002 26.0301 74.5601 26.0101 74.5201 25.9801C74.4801 25.9401 74.4702 25.9001 74.4702 25.8401V24.1601H75.0102V23.5601H74.4702V22.8501V22.8601Z" fill="currentColor"/><path d="M76.98 23.48C76.5 23.48 76.09 23.64 75.75 23.96C75.42 24.28 75.25 24.68 75.25 25.15C75.25 25.62 75.42 26.02 75.75 26.34C76.08 26.66 76.49 26.82 76.98 26.82C77.47 26.82 77.87 26.66 78.21 26.34C78.54 26.02 78.71 25.62 78.71 25.15C78.71 24.68 78.54 24.29 78.21 23.96C77.88 23.64 77.47 23.48 76.98 23.48ZM77.65 25.86C77.48 26.04 77.26 26.13 76.98 26.13C76.7 26.13 76.48 26.04 76.31 25.85C76.14 25.67 76.06 25.43 76.06 25.14C76.06 24.85 76.14 24.62 76.31 24.44C76.48 24.25 76.7 24.16 76.98 24.16C77.26 24.16 77.48 24.25 77.65 24.44C77.82 24.62 77.9 24.85 77.9 25.14C77.9 25.43 77.82 25.67 77.65 25.85V25.86Z" fill="currentColor"/><path d="M82.6403 23.48C82.4603 23.48 82.2903 23.53 82.1103 23.63C81.9403 23.73 81.7903 23.86 81.6803 24.02C81.4503 23.66 81.1603 23.48 80.8003 23.48C80.4403 23.48 80.1803 23.65 79.9803 24H79.9703V23.57H79.2603V26.72H80.0303V24.74C80.0303 24.58 80.0803 24.45 80.1903 24.35C80.3003 24.24 80.4303 24.19 80.5803 24.19C80.7303 24.19 80.8703 24.24 80.9703 24.35C81.0803 24.46 81.1302 24.59 81.1302 24.74V26.72H81.9003V24.74C81.9003 24.58 81.9502 24.45 82.0602 24.35C82.1702 24.24 82.3002 24.19 82.4502 24.19C82.6002 24.19 82.7402 24.24 82.8402 24.35C82.9502 24.46 83.0003 24.59 83.0003 24.74V26.72H83.7702V24.77C83.7702 24.38 83.6703 24.07 83.4703 23.83C83.2703 23.59 82.9903 23.47 82.6403 23.47V23.48Z" fill="currentColor"/><path d="M86.0401 23.48C85.5601 23.48 85.1501 23.64 84.8101 23.96C84.4801 24.28 84.3101 24.68 84.3101 25.15C84.3101 25.62 84.4801 26.02 84.8101 26.34C85.1401 26.66 85.5501 26.82 86.0401 26.82C86.5301 26.82 86.9301 26.66 87.2701 26.34C87.6001 26.02 87.7701 25.62 87.7701 25.15C87.7701 24.68 87.6001 24.29 87.2701 23.96C86.9401 23.64 86.5301 23.48 86.0401 23.48ZM86.7101 25.86C86.5401 26.04 86.3201 26.13 86.0401 26.13C85.7601 26.13 85.5401 26.04 85.3701 25.85C85.2001 25.67 85.1201 25.43 85.1201 25.14C85.1201 24.85 85.2001 24.62 85.3701 24.44C85.5401 24.25 85.7601 24.16 86.0401 24.16C86.3201 24.16 86.5401 24.25 86.7101 24.44C86.8801 24.62 86.9601 24.85 86.9601 25.14C86.9601 25.43 86.8801 25.67 86.7101 25.85V25.86Z" fill="currentColor"/><path d="M90.1401 23.4801C89.7101 23.4801 89.3601 23.6601 89.0901 24.0301H89.0801V22.6401H88.3101V26.7201H89.0801V26.2601H89.0901C89.3701 26.6301 89.7201 26.8201 90.1401 26.8201C90.6101 26.8201 90.9901 26.6601 91.2801 26.3501C91.5701 26.0301 91.7201 25.6301 91.7201 25.1501C91.7201 24.6701 91.5701 24.2701 91.2801 23.9601C90.9901 23.6401 90.6001 23.4901 90.1401 23.4901V23.4801ZM90.6601 25.8301C90.4901 26.0201 90.2701 26.1101 90.0001 26.1101C89.7301 26.1101 89.5201 26.0201 89.3401 25.8301C89.1701 25.6401 89.0801 25.4101 89.0801 25.1501C89.0801 24.8901 89.1701 24.6701 89.3401 24.4701C89.5101 24.2801 89.7301 24.1901 90.0001 24.1901C90.2701 24.1901 90.4801 24.2801 90.6601 24.4701C90.8301 24.6601 90.9201 24.8901 90.9201 25.1501C90.9201 25.4101 90.8301 25.6401 90.6601 25.8301Z" fill="currentColor"/><path d="M92.66 22.55C92.54 22.55 92.44 22.59 92.36 22.68C92.27 22.76 92.23 22.86 92.23 22.98C92.23 23.1 92.27 23.2001 92.36 23.2801C92.44 23.3601 92.55 23.4 92.66 23.4C92.77 23.4 92.88 23.3601 92.96 23.2801C93.04 23.2001 93.09 23.1 93.09 22.98C93.09 22.86 93.05 22.76 92.96 22.68C92.87 22.6 92.77 22.55 92.66 22.55Z" fill="currentColor"/><path d="M93.04 23.5701H92.27V26.7201H93.04V23.5701Z" fill="currentColor"/><path d="M94.4702 22.6401H93.7002V26.7201H94.4702V22.6401Z" fill="currentColor"/><path d="M98.4303 25.15C98.4303 24.68 98.2603 24.29 97.9303 23.97C97.6003 23.65 97.2003 23.49 96.7303 23.49C96.2603 23.49 95.8403 23.65 95.5103 23.97C95.1803 24.29 95.0103 24.69 95.0103 25.16C95.0103 25.63 95.1803 26.03 95.5103 26.35C95.8403 26.67 96.2503 26.83 96.7203 26.83C97.0803 26.83 97.3902 26.74 97.6702 26.55C97.9502 26.36 98.1503 26.11 98.2603 25.79H97.4202C97.3502 25.9 97.2502 25.99 97.1302 26.06C97.0002 26.13 96.8703 26.16 96.7203 26.16C96.5103 26.16 96.3203 26.1 96.1503 25.97C95.9903 25.84 95.8802 25.69 95.8402 25.51H98.3802C98.4102 25.38 98.4202 25.26 98.4202 25.16L98.4303 25.15ZM95.8603 24.83C95.9003 24.63 96.0103 24.46 96.1603 24.33C96.3203 24.2 96.5102 24.13 96.7402 24.13C96.9702 24.13 97.1502 24.2 97.3102 24.33C97.4702 24.46 97.5603 24.63 97.6103 24.83H95.8603Z" fill="currentColor"/></g><defs><clipPath id="clip0_117_213"><rect width="98.43" height="26.82" fill="white"/></clipPath></defs></svg>
            </div>
            <div class="flex items-center space-x-4">
                <a href="https://t.me/gateauto" target="_blank" rel="noopener noreferrer" aria-label="Telegram –∫–∞–Ω–∞–ª" class="text-gray-800 hover:text-black transition-colors">
                    <svg width="22" height="18" viewBox="0 0 22 18" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_1_2125)"><path d="M2.32955 7.83223C8.77692 5.12482 17.1203 1.82391 18.272 1.36705C21.293 0.17126 22.22 0.400427 21.7579 3.0486C21.4258 4.95196 20.4682 11.2536 19.7048 15.176C19.2518 17.5019 18.2355 17.7776 16.6375 16.7712C15.8691 16.287 11.9903 13.8386 11.1485 13.2637C10.38 12.7398 9.32018 12.1096 10.6494 10.8682C11.1223 10.4261 14.2229 7.60013 16.6386 5.40051C16.9551 5.11159 16.5575 4.6371 16.1923 4.86871C12.9363 6.92976 8.42192 9.79045 7.84736 10.1631C6.97936 10.7257 6.14575 10.9838 4.64933 10.5734C3.51868 10.2635 2.41419 9.89377 1.98431 9.75275C0.328855 9.21018 0.721813 8.5075 2.32955 7.83223Z" fill="currentColor"/></g><defs><clipPath id="clip0_1_2125"><rect width="22" height="18" fill="white"/></clipPath></defs></svg>
                </a>
                <a id="call-button" href="./call.html" target="_blank" rel="noopener noreferrer" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å" class="text-gray-800 hover:text-black transition-colors">
                    <svg viewBox="0 0 13 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5"><path d="M12.2279 13.1233C11.9232 12.0998 10.2993 10.6717 10.2993 10.6717C9.93047 10.3551 9.43122 10.2271 9.10449 10.5928C9.10449 10.5928 8.35417 11.1726 8.17989 11.2426C7.38382 11.5617 6.74111 11.4133 6.22397 10.6463L5.02213 8.8637L3.8203 7.08112C3.30315 6.31409 3.41906 5.68114 4.03671 5.09735C4.17204 4.9696 5.01716 4.53039 5.01716 4.53039C5.4919 4.38379 5.56993 3.88746 5.41827 3.43213C5.41827 3.43213 4.71854 1.41373 3.87514 0.734332C3.51635 0.445249 3.00598 0.417944 2.61678 0.666528L1.80802 1.18309C-0.75765 2.8218 -0.209371 5.36773 1.47429 7.86496L3.01304 10.1472L4.55179 12.4295C6.23545 14.9268 8.41689 16.4296 10.9826 14.7909L11.7913 14.2743C12.1807 14.025 12.3577 13.5583 12.2279 13.1233Z" fill="currentColor"/></svg>
                </a>
            </div>
        </header>

        <main>
            <div id="list-container">
                <div class="mb-4">
                    <h1 class="text-3xl font-bold tracking-tight">–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h1>
                </div>
                <div class="mb-6 relative">
                    <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫..." class="w-full h-14 pl-14 pr-12 py-2 text-base bg-white rounded-full border border-gray-200 focus:ring-2 focus:ring-black focus:border-black outline-none transition-shadow" />
                    <button id="clear-search-btn" class="absolute inset-y-0 right-0 pr-5 flex items-center hidden" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 hover:text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="space-y-4 mb-8">
                    <div class="flex justify-between items-center gap-4">
                        <div id="availability-filters" class="flex flex-wrap justify-start gap-2"></div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                             <button id="exclusive-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:bg-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-black" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ">
                                <!-- SVG will be injected by JS -->
                            </button>
                            <button id="layout-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-black" aria-label="–°–º–µ–Ω–∏—Ç—å –≤–∏–¥">
                                <!-- Icon will be injected by JS -->
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="relative">
                            <select id="brand-select" class="appearance-none bg-transparent py-2 pl-10 pr-4 text-gray-700 font-medium cursor-pointer focus:outline-none" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É"></select>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                               <svg width="23" height="14" viewBox="0 0 23 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5"><rect y="2" width="14" height="3" rx="1.5" fill="currentColor"/><rect x="17" y="2" width="6" height="3" rx="1.5" fill="currentColor"/><circle cx="15.5" cy="3.5" r="2.5" stroke="currentColor" stroke-width="2"/><rect x="23" y="12" width="14" height="3" rx="1.5" transform="rotate(-180 23 12)" fill="currentColor"/><rect x="6" y="12" width="6" height="3" rx="1.5" transform="rotate(-180 6 12)" fill="currentColor"/><circle cx="7.5" cy="10.5" r="2.5" transform="rotate(-180 7.5 10.5)" stroke="currentColor" stroke-width="2"/></svg>
                            </div>
                        </div>
                        <div class="relative">
                            <select id="sort-select" class="appearance-none bg-transparent py-2 pl-10 pr-4 text-gray-700 font-medium cursor-pointer focus:outline-none" aria-label="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
                                <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                                <option value="price-asc">–î–µ—à–µ–≤–ª–µ</option>
                                <option value="price-desc">–î–æ—Ä–æ–∂–µ</option>
                            </select>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                               <svg width="16" height="13" viewBox="0 0 16 13" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5"><path d="M4.14282 1V12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7.28571 8.85715L4.14286 12L1 8.85715" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.2144 12L11.2144 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.07146 4.14285L11.2143 0.999995L14.3572 4.14285" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="content-area"></div>
            </div>
            <div id="detail-container" class="hidden"></div>
        </main>
        
        <footer class="text-center py-6 mt-12 border-t border-gray-200">
            <p class="text-sm text-gray-500 mb-2"></p>
            <p class="text-xs text-gray-500 mt-2 max-w-2xl mx-auto">–ù–µ —è–≤–ª—è–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–æ–π. –°–≤–µ–¥–µ–Ω–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —è–≤–ª—è—é—Ç—Å—è —Ä–µ–∫–ª–∞–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –º–æ–≥—É—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –ø—Ä–æ–¥–∞–∂–∏. –í—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Å —Ü–µ–ª—å—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –î–ª—è —Ç–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–µ –∏ —Ü–µ–Ω–∞—Ö —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏.</p>
            <div class="mt-4 flex justify-center items-center gap-2">
                <span class="inline-block bg-gray-200 text-gray-600 text-xs font-semibold px-2.5 py-0.5 rounded-full">Beta 4.11.15</span>
                <a href="https://yandex.by/maps/org/gate_automobile/152188575796/?from=mapframe&ll=37.670141%2C55.714044&z=16" target="_blank" rel="noopener noreferrer" class="inline-block text-black text-xs font-semibold px-2.5 py-0.5 rounded-full" style="background-color: #FFCC00;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö</a>
            </div>
        </footer>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START OF STATE & CONFIG ---
    let cars = [];
    let state = {
        loading: true,
        error: null,
        searchTerm: '',
        activeFilter: '–í—Å–µ',
        selectedBrand: '–í—Å–µ –±—Ä–µ–Ω–¥—ã',
        sortOrder: 'default',
        eurRate: null,
        currentView: 'list', // 'list' or 'detail'
        selectedCarId: null,
        gridLayout: 'grid', // 'grid' (2-col) or 'list' (1-col)
        renderedItemsCount: 20,
        itemsPerLoad: 10,
    };
    const FEED_URL = 'https://autos.autocrm.ru/api/auto-ru/feed?id=jtEjHMTcfwjkVwRngrnbRw%3D%3D&isUsed=0';
    const PROXY_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(FEED_URL)}`;
    
    let observer = null;
    let filteredCarsCache = [];
    // --- END OF STATE & CONFIG ---

    // --- START OF DOM ELEMENT REFERENCES ---
    const listContainer = document.getElementById('list-container');
    const detailContainer = document.getElementById('detail-container');
    const contentArea = document.getElementById('content-area');
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search-btn');
    const availabilityFiltersContainer = document.getElementById('availability-filters');
    const brandSelect = document.getElementById('brand-select');
    const sortSelect = document.getElementById('sort-select');
    const layoutToggleBtn = document.getElementById('layout-toggle-btn');
    const exclusiveToggleBtn = document.getElementById('exclusive-toggle-btn');
    // --- END OF DOM ELEMENT REFERENCES ---
    
    // --- ICONS ---
    const starIconInactiveSVG = `<svg class="w-6 h-6" viewBox="0 0 55 55" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.1663 52.1331C14.245 52.1331 13.2756 51.9131 12.3819 51.2325C10.7456 49.9881 10.4569 48.0631 10.3881 46.5231C10.3056 44.7356 10.5256 42.4875 10.8281 39.3663L10.9794 37.8125C11.1306 36.2794 11.1856 35.585 11.0481 35.145C10.9106 34.7119 10.4775 34.1894 9.50126 33.0481L8.50438 31.8863C6.50376 29.5488 5.06001 27.8575 4.11813 26.3588C3.37563 25.1763 2.45438 23.3681 3.08001 21.3606C3.71251 19.3256 5.50001 18.4181 6.79251 17.9094C8.40813 17.27 10.5325 16.7956 13.4681 16.1288L14.9256 15.7988C16.3419 15.4756 16.9813 15.3244 17.3113 15.0769C17.6688 14.8088 18.0469 14.1281 18.7275 12.9044L19.4769 11.5569C20.9894 8.84813 22.0756 6.88876 23.1481 5.49313C24.0144 4.36563 25.4031 2.86688 27.5 2.86688C29.5969 2.86688 30.9856 4.36563 31.8519 5.49313C32.9244 6.89563 34.0175 8.84813 35.5231 11.5569L36.2725 12.9044C36.96 14.135 37.3381 14.8088 37.6888 15.0769C38.0188 15.3313 38.6581 15.4825 40.0744 15.7988L41.5319 16.1288C44.4675 16.7956 46.5919 17.2769 48.2075 17.9094C49.5 18.4181 51.2875 19.3325 51.92 21.3606C52.5456 23.3681 51.6244 25.1763 50.8819 26.3588C49.94 27.8575 48.4963 29.5488 46.4956 31.8863L45.4988 33.0481C44.5225 34.1894 44.0825 34.7119 43.9519 35.145C43.8144 35.585 43.8763 36.2794 44.0206 37.8125L44.1719 39.3663C44.4744 42.4806 44.6944 44.7356 44.6119 46.5231C44.5431 48.0631 44.2544 49.9881 42.6181 51.2325C40.92 52.5181 38.9331 52.1538 37.5925 51.7688C35.9288 51.2944 33.9419 50.38 31.1919 49.1081L29.8238 48.4756C28.5931 47.9119 27.9194 47.5956 27.5 47.5956C27.0806 47.5956 26.4069 47.905 25.1763 48.4756L23.8081 49.1081C21.0581 50.3731 19.0713 51.2875 17.4075 51.7688C16.7681 51.9544 15.9913 52.1263 15.1663 52.1263V52.1331ZM27.5 6.30438C26.3381 6.30438 24.7225 9.21251 22.4744 13.2344L21.725 14.5819C20.8175 16.2181 20.3156 17.1188 19.3806 17.82C18.4388 18.535 17.4006 18.7688 15.675 19.1606L14.2175 19.4906C11.5363 20.0956 9.41188 20.5769 8.04376 21.12C6.57251 21.6975 6.42126 22.1719 6.35251 22.3988C6.24251 22.7563 6.23563 23.2925 7.01938 24.5438C7.83063 25.8294 9.27438 27.5206 11.11 29.6656L12.1069 30.8275C13.31 32.2369 13.9769 33.0138 14.3275 34.1413C14.6781 35.2619 14.575 36.2931 14.3963 38.1631L14.245 39.7169C13.7775 44.5569 13.4681 47.7538 14.4581 48.51C15.3931 49.2181 18.1706 47.9394 22.3713 46.0075L23.7394 45.375C25.355 44.6325 26.3313 44.1788 27.5 44.1788C28.6688 44.1788 29.645 44.6256 31.2606 45.3681L32.6288 46.0006C36.8294 47.9325 39.6069 49.2113 40.5419 48.5031C41.5319 47.7538 41.2225 44.55 40.755 39.71L40.6038 38.1563C40.425 36.2863 40.3219 35.255 40.6725 34.1344C41.0231 33.0069 41.69 32.23 42.8931 30.8206L43.89 29.6588C45.7256 27.5138 47.1694 25.8225 47.9806 24.5369C48.7713 23.2856 48.7575 22.7494 48.6475 22.3919C48.5788 22.165 48.4344 21.6975 46.9563 21.1131C45.5881 20.57 43.4638 20.0956 40.7825 19.4838L39.325 19.1538C37.5994 18.7619 36.5613 18.5281 35.6194 17.8131C34.6913 17.105 34.1894 16.2113 33.275 14.575L32.5256 13.2275C30.2844 9.20563 28.6619 6.29751 27.5 6.29751V6.30438Z" fill="currentColor"/></svg>`;
    const starIconActiveSVG = `<svg class="w-6 h-6" viewBox="0 0 153 153" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58.3504 34.4823C66.4212 20.0047 70.4565 12.7563 76.5 12.7563C82.5435 12.7563 86.5789 20.0047 94.6497 34.4823L96.7343 38.2308C99.0293 42.3427 100.177 44.4082 101.975 45.7661C103.772 47.124 105.991 47.6212 110.447 48.6348L114.501 49.5528C130.184 53.1101 138.025 54.8696 139.88 60.8748C141.755 66.8801 136.4 73.1148 125.709 85.6226L122.936 88.8547C119.895 92.412 118.384 94.1906 117.695 96.3708C117.007 98.5702 117.236 100.942 117.695 105.685L118.116 110.007C119.723 126.684 120.545 135.022 115.649 138.733C110.772 142.443 103.428 139.058 88.74 132.307L84.9342 130.566C80.7649 128.654 78.6803 127.678 76.4618 127.678C74.2433 127.678 72.1587 128.635 67.9894 130.566L64.1835 132.307C49.4955 139.058 42.1515 142.443 37.2747 138.733C32.3978 135.022 33.201 126.684 34.8075 110.007L35.2283 105.685C35.6873 100.942 35.9168 98.5702 35.2283 96.3708C34.5398 94.1715 33.0289 92.3929 29.988 88.8547L27.2149 85.6226C16.524 73.1148 11.1882 66.8801 13.0433 60.8748C14.9175 54.8696 22.7396 53.1101 38.4222 49.5528L42.4767 48.6348C46.9328 47.6212 49.1513 47.124 50.949 45.7661C52.7468 44.4082 53.8943 42.3427 56.1893 38.2308L58.2739 34.4823H58.3504Z" fill="white"/></svg>`;

    // --- START OF SERVICES (DATA FETCHING & PARSING) ---
    const getSafeTextContent = (element, tagName) => {
        return element.getElementsByTagName(tagName)[0]?.textContent?.trim() ?? '';
    };

    const getPriceInfo = (priceStr) => {
        const value = parseInt(priceStr, 10) || 0;
        let currency = 'EUR';

        // If length > 7, it's RUB.
        // If length is exactly 7 AND value is > 2,000,000, it's also RUB.
        // Otherwise (length <= 6, or length 7 and value <= 2,000,000), it's EUR.
        if (priceStr.length > 7 || (priceStr.length === 7 && value > 2000000)) {
            currency = 'RUB';
        }

        return { value, currency };
    };

    const fetchAndParseCars = async (initialCarId = null) => {
        const CACHE_KEY = 'gateAutoCarData';
        const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes in milliseconds
        
        let hasRenderedFromCache = false;
        
        // --- 1. Attempt to load from cache ---
        const cachedItem = localStorage.getItem(CACHE_KEY);
        if (cachedItem) {
            try {
                const { timestamp, cachedCars, cachedEurRate } = JSON.parse(cachedItem);
                if (Date.now() - timestamp < CACHE_DURATION) {
                    cars = cachedCars;
                    state.eurRate = cachedEurRate;
                    hasRenderedFromCache = true;
                    console.log(`Loaded ${cars.length} cars from cache.`);
                } else {
                    console.log("Cache is expired.");
                    localStorage.removeItem(CACHE_KEY);
                }
            } catch (e) {
                console.error("Failed to parse cache, removing it.", e);
                localStorage.removeItem(CACHE_KEY);
            }
        }
        
        // --- 2. Initial Render ---
        if (hasRenderedFromCache) {
            state.loading = false;
            if (initialCarId) {
                const carExists = cars.some(c => c.id === initialCarId);
                if (carExists) {
                    state.currentView = 'detail';
                    state.selectedCarId = initialCarId;
                } else {
                    const url = new URL(window.location);
                    url.searchParams.delete('car');
                    window.history.replaceState({}, '', url);
                }
            }
            state.renderedItemsCount = 20;
            renderApp(true);
        } else {
            state.loading = true;
            state.error = null;
            renderApp();
        }

        // --- 3. Fetch fresh data from network ---
        const RATE_API_URL = 'https://www.cbr-xml-daily.ru/daily.xml';
        const RATE_PROXY_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RATE_API_URL)}`;

        try {
            const [carResponse, rateResponse] = await Promise.all([
                fetch(PROXY_URL),
                fetch(RATE_PROXY_URL).catch(e => {
                    console.error("Rate fetch failed, proceeding without it.", e);
                    return null;
                })
            ]);

            if (!carResponse || !carResponse.ok) {
                throw new Error(`Failed to fetch car feed: ${carResponse?.statusText || 'Unknown error'}`);
            }
            
            let freshEurRate = null;
            if (rateResponse && rateResponse.ok) {
                try {
                    const rateXmlText = await rateResponse.text();
                    const rateParser = new DOMParser();
                    const rateXmlDoc = rateParser.parseFromString(rateXmlText, "application/xml");
                    const eurValuteNode = rateXmlDoc.querySelector('Valute[ID="R01239"]');
                    if (eurValuteNode) {
                        const valueStr = eurValuteNode.querySelector('Value')?.textContent;
                        if (valueStr) {
                            freshEurRate = parseFloat(valueStr.replace(',', '.'));
                        }
                    }
                } catch (rateError) {
                    console.error("Could not parse EUR rate, proceeding without it.", rateError);
                }
            }
            
            const xmlText = await carResponse.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "application/xml");
            const errorNode = xmlDoc.querySelector('parsererror');
            if (errorNode) {
                throw new Error('Failed to parse XML feed.');
            }
            
            const carNodes = Array.from(xmlDoc.getElementsByTagName('car'));
            let freshCars = carNodes.map(node => {
                const priceStr = getSafeTextContent(node, 'price');
                const discountPriceStr = getSafeTextContent(node, 'discount_price');
                const brand = getSafeTextContent(node, 'mark_id');
                const model = getSafeTextContent(node, 'folder_id');
                const complectationName = getSafeTextContent(node, 'complectation_name');
                let carName = `${brand} ${model}`;
                
                const description = getSafeTextContent(node, 'description');
                let mileage = null;
                const mileageMatch = description.match(/–ü—Ä–æ–±–µ–≥:\s*(\d+)/);
                if (mileageMatch && mileageMatch[1]) {
                    mileage = `${mileageMatch[1].trim()} –∫–º`;
                }

                let vatStatus = null;
                const descriptionLower = description.toLowerCase();
                if (descriptionLower.includes('—Å –Ω–¥—Å')) {
                    vatStatus = '—Å –ù–î–° 20%';
                } else if (descriptionLower.includes('–±–µ–∑ –Ω–¥—Å')) {
                    vatStatus = '–±–µ–∑ –ù–î–°';
                }

                const car = {
                    id: getSafeTextContent(node, 'unique_id'),
                    name: carName,
                    brand: brand,
                    complectation: (complectationName && complectationName !== model) ? complectationName : null,
                    color: getSafeTextContent(node, 'color'),
                    availability: getSafeTextContent(node, 'availability'),
                    year: parseInt(getSafeTextContent(node, 'year'), 10) || new Date().getFullYear(),
                    mileage: mileage,
                    vatStatus: vatStatus,
                    price: getPriceInfo(priceStr).value,
                    priceCurrency: getPriceInfo(priceStr).currency,
                    images: Array.from(node.getElementsByTagName('image')).map(img => img.textContent ?? '').filter(Boolean),
                    engineVolume: getSafeTextContent(node, 'engine_volume'),
                    enginePower: getSafeTextContent(node, 'engine_power'),
                    engineType: getSafeTextContent(node, 'engine_type'),
                    gearbox: getSafeTextContent(node, 'gearbox'),
                    drive: getSafeTextContent(node, 'drive'),
                    maxDiscount: parseInt(getSafeTextContent(node, 'max_discount'), 10) || 0,
                    currentImageIndex: 0,
                    kpLink: getSafeTextContent(node, 'link'),
                    isExclusive: description.toLowerCase().includes('—ç–∫—Å–∫–ª—é–∑–∏–≤'),
                };

                if (discountPriceStr) {
                    const discountInfo = getPriceInfo(discountPriceStr);
                    car.discountPrice = discountInfo.value;
                    car.discountPriceCurrency = discountInfo.currency;
                }
                return car;
            }).filter(car => car.id);
            
            freshCars.forEach(car => {
                if (freshEurRate && car.priceCurrency === 'EUR') {
                    car.finalPrice = car.price * freshEurRate;
                    car.finalPriceCurrency = 'RUB';
                } else {
                    car.finalPrice = car.price;
                    car.finalPriceCurrency = car.priceCurrency;
                }
                if (car.discountPrice) {
                    if (freshEurRate && car.discountPriceCurrency === 'EUR') {
                        car.finalDiscountPrice = car.discountPrice * freshEurRate;
                        car.finalDiscountPriceCurrency = 'RUB';
                    } else {
                        car.finalDiscountPrice = car.discountPrice;
                        car.finalDiscountPriceCurrency = car.discountPriceCurrency;
                    }
                } else {
                    car.finalDiscountPrice = car.discountPrice;
                }
            });

            const oldDataString = JSON.stringify({ cars, eurRate: state.eurRate });
            const newDataString = JSON.stringify({ cars: freshCars, eurRate: freshEurRate });
            
            if (oldDataString !== newDataString) {
                console.log("Network data is different. Updating UI and cache.");
                cars = freshCars;
                state.eurRate = freshEurRate;

                const newCacheItem = {
                    timestamp: Date.now(),
                    cachedCars: cars,
                    cachedEurRate: state.eurRate
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(newCacheItem));

                if (state.currentView === 'detail' && !cars.some(c => c.id === state.selectedCarId)) {
                    state.currentView = 'list';
                    state.selectedCarId = null;
                    const url = new URL(window.location);
                    url.searchParams.delete('car');
                    window.history.pushState({}, '', url);
                }

                if (state.loading) {
                    state.loading = false;
                    if (initialCarId) {
                        const carExists = cars.some(c => c.id === initialCarId);
                        if (carExists) {
                            state.currentView = 'detail';
                            state.selectedCarId = initialCarId;
                        } else {
                            const url = new URL(window.location);
                            url.searchParams.delete('car');
                            window.history.replaceState({}, '', url);
                        }
                    }
                }
                state.renderedItemsCount = 20;
                renderApp(true);
            } else if (state.loading) {
                console.log("Network data is the same. Hiding loader.");
                state.loading = false;
                renderApp(true);
            } else {
                console.log("Network data is the same as cached. No UI update needed.");
            }
        } catch (error) {
            console.error("Error fetching fresh data:", error);
            if (!hasRenderedFromCache) {
                state.loading = false;
                state.error = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª—è—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.";
                renderApp();
            }
        }
    };
    // --- END OF SERVICES ---

    // --- START OF RENDERING LOGIC ---
    const colorMap = {
        '–ë–µ–ª—ã–π': '#FFFFFF',
        '–ß–µ—Ä–Ω—ã–π': '#000000',
        '–°–µ—Ä—ã–π': '#808080',
        '–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π': '#C0C0C0',
        '–ö—Ä–∞—Å–Ω—ã–π': '#FF0000',
        '–°–∏–Ω–∏–π': '#0000FF',
        '–ó–µ–ª–µ–Ω—ã–π': '#008000',
        '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π': '#A52A2A',
        '–ë–µ–∂–µ–≤—ã–π': '#F5F5DC',
        '–ì–æ–ª—É–±–æ–π': '#ADD8E6',
        '–û—Ä–∞–Ω–∂–µ–≤—ã–π': '#FFA500',
        '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π': '#800080',
        '–ñ–µ–ª—Ç—ã–π': '#FFFF00',
    };

    const getHexForColorName = (colorName) => {
      if (!colorName) return null;
      const normalizedColor = colorName.trim().charAt(0).toUpperCase() + colorName.trim().slice(1).toLowerCase();
      return colorMap[normalizedColor] || null;
    };

    const formatCurrency = (amount, currency) => {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        }).format(amount);
    };
    
    const shareCar = async (car) => {
        if (!car) return;

        let text;
        if (car.priceCurrency === 'EUR' && !state.eurRate) {
            text = `–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —ç—Ç–æ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å: ${car.name}`;
        } else {
            const hasDiscount = car.maxDiscount > 0 && car.finalDiscountPrice && car.finalDiscountPrice > 0;
            const displayPrice = hasDiscount ? car.finalDiscountPrice : car.finalPrice;
            const displayCurrency = hasDiscount ? car.finalDiscountPriceCurrency : car.finalPriceCurrency;
            text = `–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —ç—Ç–æ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å: ${car.name} - ${formatCurrency(displayPrice, displayCurrency)}`;
        }

        const carUrl = new URL(window.location.href.split('?')[0]);
        carUrl.searchParams.set('car', car.id);

        const shareData = {
            title: 'Gate Automobile',
            text: text,
            url: carUrl.toString()
        };

        if (navigator.share) {
            try {
                await navigator.share(shareData);
            } catch (err) {
                // User cancelled share is not an error, so we can ignore it.
                if (err.name !== 'AbortError') {
                    console.error('Error sharing:', err);
                }
            }
        } else {
            // Fallback for desktop/unsupported browsers
            try {
                await navigator.clipboard.writeText(`${shareData.text}\n\n${shareData.url}`);
                alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.');
            }
        }
    };

    const createCarCardHTML = (car) => {
        const hasDiscount = car.maxDiscount > 0 && car.finalDiscountPrice && car.finalDiscountPrice > 0;
        const displayPrice = hasDiscount ? car.finalDiscountPrice : car.finalPrice;
        const displayCurrency = hasDiscount ? car.finalDiscountPriceCurrency : car.finalPriceCurrency;
        const originalPriceForStrikethrough = car.finalPrice;
        const originalPriceCurrencyForStrikethrough = car.finalPriceCurrency;

        let priceBlockHTML;
        // –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∞—è –≤–∞–ª—é—Ç–∞ –±—ã–ª–∞ EUR, –Ω–æ –∫—É—Ä—Å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.
        if (car.priceCurrency === 'EUR' && !state.eurRate) {
            priceBlockHTML = `
                <div class="text-base font-medium text-red-600 min-h-[2.5rem] flex items-center">
                    –ù–µ —É–¥–∞–ª–æ—Å—å<br>–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É
                </div>
            `;
        } else {
            priceBlockHTML = `
                <div class="text-xl font-bold">
                    ${hasDiscount ? `<span class="line-through text-gray-400 text-base font-medium mr-2">${formatCurrency(originalPriceForStrikethrough, originalPriceCurrencyForStrikethrough)}</span>` : ''}
                    ${formatCurrency(displayPrice, displayCurrency)}
                </div>
            `;
        }

        let vatStatusHTML = '';
        if (car.vatStatus) {
            vatStatusHTML = ` &bull; ${car.vatStatus === '—Å –ù–î–° 20%' ? `<span style="color: #21CC50; font-weight: 500;">${car.vatStatus}</span>` : car.vatStatus}`;
        }

        const availabilityStyles = {
            '–í –Ω–∞–ª–∏—á–∏–∏': 'bg-[#21CC50] text-white',
            '–í –ø—É—Ç–∏': 'bg-[#82B6D1] text-white',
        };
        const availabilityClass = availabilityStyles[car.availability] || 'bg-gray-100 text-gray-600';
        const showElectro = !car.engineVolume || car.engineVolume === '-';
        
        const imagesHTML = car.images.length > 0 ?
            `<img src="${car.images[car.currentImageIndex]}" alt="${car.name}" class="w-full h-full object-cover">` :
            `<div class="w-full h-full flex items-center justify-center"><span class="text-gray-400">–ù–µ—Ç —Ñ–æ—Ç–æ</span></div>`;
        
        const detailsButtonHTML = car.isExclusive
            ? `<button data-action="details" data-car-id="${car.id}" class="w-full h-14 text-white text-base font-bold rounded-full transition-all transform active:scale-95" style="background: linear-gradient(to right, #C2A55A, #946E20);">–≠–∫—Å–∫–ª—é–∑–∏–≤</button>`
            : `<button data-action="details" data-car-id="${car.id}" class="w-full h-14 bg-black text-white text-base font-bold rounded-full hover:bg-gray-800 transition-all transform active:scale-95">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>`;


        return `
            <div class="bg-white rounded-[2rem] shadow-sm overflow-hidden flex flex-col h-full group">
                <div class="p-4 flex-grow flex flex-col">
                    <div class="flex justify-between items-start">
                        <h2 data-action="details" data-car-id="${car.id}" class="text-xl font-bold text-gray-900 leading-tight min-h-[3.5rem] line-clamp-2 flex-grow pr-2 cursor-pointer hover:text-gray-700 transition-colors">${car.name}</h2>
                        <button data-action="share" data-car-id="${car.id}" class="bg-black text-white rounded-full p-2.5 flex-shrink-0 hover:bg-gray-800 transition-colors" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" /></svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">${car.year} –≥–æ–¥${car.mileage ? ` &bull; ${car.mileage}` : ''}${vatStatusHTML}</p>
                    <div class="flex flex-col items-start my-4">
                        ${priceBlockHTML}
                        <div class="flex flex-wrap items-center gap-2 mt-2 w-full">
                            <div class="text-xs font-semibold px-3 py-1 rounded-full ${availabilityClass}">${car.availability}</div>
                            ${showElectro ? 
                                `<div class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-600">–≠–ª–µ–∫—Ç—Ä–æ</div>` : 
                                `<div class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-600">${car.engineVolume} —Å–º¬≥</div>`
                            }
                            ${car.enginePower ? `<div class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-600">${car.enginePower} –ª.—Å.</div>` : ''}
                        </div>
                    </div>
                    <div data-action="details" data-car-id="${car.id}" class="relative w-full aspect-[16/10] bg-gray-100 rounded-3xl overflow-hidden mt-auto cursor-pointer" data-swipeable-id="${car.id}">
                        ${imagesHTML}
                    </div>
                    <div class="mt-4">
                        ${detailsButtonHTML}
                    </div>
                </div>
            </div>`;
    };

    const createCarCardGridHTML = (car) => {
        const hasDiscount = car.maxDiscount > 0 && car.finalDiscountPrice && car.finalDiscountPrice > 0;
        const displayPrice = hasDiscount ? car.finalDiscountPrice : car.finalPrice;
        const displayCurrency = hasDiscount ? car.finalDiscountPriceCurrency : car.finalPriceCurrency;
        const originalPriceForStrikethrough = car.finalPrice;
        const originalPriceCurrencyForStrikethrough = car.finalPriceCurrency;

        let priceBlockHTML;
        if (car.priceCurrency === 'EUR' && !state.eurRate) {
            priceBlockHTML = `<div class="text-sm font-bold text-red-600 min-h-[46px] flex items-center">–¶–µ–Ω–∞ –≤ EUR</div>`;
        } else {
            const priceLine = `<div class="text-lg font-bold">${formatCurrency(displayPrice, displayCurrency)}</div>`;
            const discountLine = hasDiscount 
                ? `<div class="line-through text-gray-400 text-xs">${formatCurrency(originalPriceForStrikethrough, originalPriceCurrencyForStrikethrough)}</div>` 
                : '<div class="h-[18px]"></div>'; // Placeholder to prevent jumping
            priceBlockHTML = `<div>${priceLine}${discountLine}</div>`;
        }

        const availabilityStyles = {
            '–í –Ω–∞–ª–∏—á–∏–∏': 'bg-[#21CC50] text-white',
            '–í –ø—É—Ç–∏': 'bg-[#82B6D1] text-white',
        };
        const availabilityClass = availabilityStyles[car.availability] || 'bg-gray-100 text-gray-600';
        
        const imagesHTML = car.images.length > 0 ?
            `<img src="${car.images[car.currentImageIndex]}" alt="${car.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">` :
            `<div class="w-full h-full flex items-center justify-center"><span class="text-gray-400">–ù–µ—Ç —Ñ–æ—Ç–æ</span></div>`;
        
        const detailsButtonHTML = car.isExclusive
            ? `<button data-action="details" data-car-id="${car.id}" class="w-full h-12 text-white text-sm font-bold rounded-full transition-all transform active:scale-95" style="background: linear-gradient(to right, #C2A55A, #946E20);">–≠–∫—Å–∫–ª—é–∑–∏–≤</button>`
            : `<button data-action="details" data-car-id="${car.id}" class="w-full h-12 bg-black text-white text-sm font-bold rounded-full hover:bg-gray-800 transition-all transform active:scale-95">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>`;

        return `
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden flex flex-col h-full group">
                 <div class="p-3 flex flex-col flex-grow">
                    <h2 data-action="details" data-car-id="${car.id}" class="text-base font-bold text-gray-900 leading-tight min-h-[2.5rem] line-clamp-2 mb-2 cursor-pointer hover:text-gray-700 transition-colors">${car.name}</h2>

                    <div data-action="details" data-car-id="${car.id}" class="relative w-full aspect-[16/10] bg-gray-100 overflow-hidden rounded-xl cursor-pointer" data-swipeable-id="${car.id}">
                        ${imagesHTML}
                    </div>

                    <div class="flex justify-between items-center mt-3">
                        <div class="text-xs font-semibold px-2 py-1 rounded-full ${availabilityClass} flex-shrink-0 whitespace-nowrap">${car.availability}</div>
                        <p class="text-xs text-gray-500">${car.year} –≥–æ–¥</p>
                    </div>
                    
                    <div class="mt-2 mb-3">
                        ${priceBlockHTML}
                    </div>
                    
                    <div class="mt-auto">
                        ${detailsButtonHTML}
                    </div>
                </div>
            </div>`;
    };
    
    const createCarDetailHTML = (car) => {
        const hasDiscount = car.maxDiscount > 0 && car.finalDiscountPrice && car.finalDiscountPrice > 0;
        const displayPrice = hasDiscount ? car.finalDiscountPrice : car.finalPrice;
        const displayCurrency = hasDiscount ? car.finalDiscountPriceCurrency : car.finalPriceCurrency;
        const originalPriceForStrikethrough = car.finalPrice;
        const originalPriceCurrencyForStrikethrough = car.finalPriceCurrency;

        let priceBlockHTML;
        if (car.priceCurrency === 'EUR' && !state.eurRate) {
            priceBlockHTML = `
                <div class="text-xl font-medium text-red-600">
                    –ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É –≤ —Ä—É–±–ª–∏.
                </div>
            `;
        } else {
            priceBlockHTML = `
                <div class="text-3xl font-bold">
                    ${hasDiscount ? `<span class="line-through text-gray-400 text-xl font-medium mr-3">${formatCurrency(originalPriceForStrikethrough, originalPriceCurrencyForStrikethrough)}</span>` : ''}
                    ${formatCurrency(displayPrice, displayCurrency)}
                </div>
            `;
        }

        const availabilityStyles = {
            '–í –Ω–∞–ª–∏—á–∏–∏': 'bg-[#21CC50] text-white',
            '–í –ø—É—Ç–∏': 'bg-[#82B6D1] text-white',
        };
        const availabilityClass = availabilityStyles[car.availability] || 'bg-gray-100 text-gray-600';

        const imagesHTML = car.images.length > 0 ?
            `<img src="${car.images[car.currentImageIndex]}" alt="${car.name}" class="w-full h-full object-cover">` :
            `<div class="w-full h-full flex items-center justify-center bg-gray-100 rounded-3xl"><span class="text-gray-400">–ù–µ—Ç —Ñ–æ—Ç–æ</span></div>`;
        
        const imageNavButtonsHTML = car.images.length > 1 ? `
            <button data-action="prev-image" data-car-id="${car.id}" class="absolute left-3 top-1/2 -translate-y-1/2 z-10 w-10 h-10 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-colors transform active:scale-90" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <button data-action="next-image" data-car-id="${car.id}" class="absolute right-3 top-1/2 -translate-y-1/2 z-10 w-10 h-10 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-colors transform active:scale-90" aria-label="–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
            </button>
        ` : '';
            
        const characteristics = [
            { label: '–ì–æ–¥', value: car.year },
            { label: '–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è', value: car.complectation },
            { label: '–ü—Ä–æ–±–µ–≥', value: car.mileage },
            { label: '–¶–≤–µ—Ç', value: car.color, type: 'color' },
            { label: '–û–±—ä–µ–º', value: car.engineVolume, unit: ' —Å–º¬≥' },
            { label: '–ú–æ—â–Ω–æ—Å—Ç—å', value: car.enginePower, unit: ' –ª.—Å.' },
            { label: '–î–≤–∏–≥–∞—Ç–µ–ª—å', value: car.engineType },
            { label: '–ö–æ—Ä–æ–±–∫–∞', value: car.gearbox },
            { label: '–ü—Ä–∏–≤–æ–¥', value: car.drive },
        ].filter(item => item.value && item.value !== '-');

        characteristics.push({ type: 'kpLink', value: car.kpLink });
        
        const characteristicsHTML = characteristics
            .map(item => {
                if (item.type === 'kpLink') {
                    const kpLinkHTML = item.value
                        ? `<a href="${item.value}" target="_blank" rel="noopener noreferrer" class="font-medium text-lg text-gray-900 hover:underline">–°–∫–∞—á–∞—Ç—å –ö–ü –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</a>`
                        : `<span class="font-medium text-lg text-gray-500">–ö–ü –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è</span>`;
                    return `<div class="flex items-center gap-4 py-3 border-b border-gray-200">
                        <div class="flex-shrink-0">
                            <svg width="32.5" height="36.5" viewBox="0 0 65 73" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.25 0C11.7406 0 9.6875 2.05312 9.6875 4.5625V68.4375C9.6875 70.9469 11.7406 73 14.25 73H59.875C62.3844 73 64.4375 70.9469 64.4375 68.4375V18.25L46.1875 0H14.25Z" fill="#E2E5E7"/>
                                <path d="M50.75 18.25H64.4375L46.1875 0V13.6875C46.1875 16.1969 48.2406 18.25 50.75 18.25Z" fill="#B0B7BD"/>
                                <path d="M64.4375 31.9375L50.75 18.25H64.4375V31.9375Z" fill="#CAD1D8"/>
                                <path d="M55.3125 59.3125C55.3125 60.5672 54.2859 61.5938 53.0312 61.5938H2.84375C1.58906 61.5938 0.5625 60.5672 0.5625 59.3125V36.5C0.5625 35.2453 1.58906 34.2188 2.84375 34.2188H53.0312C54.2859 34.2188 55.3125 35.2453 55.3125 36.5V59.3125Z" fill="#F15642"/>
                                <path d="M10.5065 43.2228C10.5065 42.6206 10.981 41.9636 11.7452 41.9636H15.9587C18.3312 41.9636 20.4664 43.5513 20.4664 46.5945C20.4664 49.478 18.3312 51.084 15.9587 51.084H12.9132V53.493C12.9132 54.296 12.4022 54.75 11.7452 54.75C11.1429 54.75 10.5065 54.296 10.5065 53.493V43.2228ZM12.9132 44.2608V48.8051H15.9587C17.1814 48.8051 18.1487 47.726 18.1487 46.5945C18.1487 45.3193 17.1814 44.2608 15.9587 44.2608H12.9132Z" fill="white"/>
                                <path d="M24.0389 54.75C23.4366 54.75 22.7796 54.4215 22.7796 53.6208V43.2593C22.7796 42.6046 23.4366 42.1278 24.0389 42.1278H28.2158C36.5515 42.1278 36.369 54.75 28.3801 54.75H24.0389ZM25.1886 44.3543V52.5258H28.2158C33.141 52.5258 33.36 44.3543 28.2158 44.3543H25.1886Z" fill="white"/>
                                <path d="M39.3255 44.5003V47.3998H43.977C44.634 47.3998 45.291 48.0568 45.291 48.6933C45.291 49.2955 44.634 49.7883 43.977 49.7883H39.3255V53.6185C39.3255 54.2573 38.8716 54.7477 38.2328 54.7477C37.4298 54.7477 36.9393 54.2573 36.9393 53.6185V43.2571C36.9393 42.6023 37.4321 42.1256 38.2328 42.1256H44.6363C45.4393 42.1256 45.9138 42.6023 45.9138 43.2571C45.9138 43.8411 45.4393 44.4981 44.6363 44.4981H39.3255V44.5003Z" fill="white"/>
                                <path d="M53.0312 61.5938H9.6875V63.875H53.0312C54.2859 63.875 55.3125 62.8484 55.3125 61.5938V59.3125C55.3125 60.5672 54.2859 61.5938 53.0312 61.5938Z" fill="#CAD1D8"/>
                            </svg>
                        </div>
                        <div class="flex-grow">
                            ${kpLinkHTML}
                        </div>
                    </div>`;
                }

                let valueHTML;
                if (item.type === 'color') {
                    const colorHex = getHexForColorName(item.value);
                    valueHTML = `<div class="flex items-center gap-2">
                        ${colorHex ? `<div class="w-5 h-5 rounded-full ${colorHex === '#FFFFFF' ? 'border border-gray-300' : ''}" style="background-color: ${colorHex};"></div>` : ''}
                        <span>${item.value}</span>
                    </div>`;
                } else {
                    valueHTML = `<span>${item.value}${item.unit || ''}</span>`;
                }
                return `<div class="flex justify-between items-center py-3 border-b border-gray-200">
                    <dt class="text-gray-500">${item.label}</dt>
                    <dd class="font-medium text-gray-900">${valueHTML}</dd>
                </div>`;
            })
            .join('');
        
        const exclusiveBadgeHTML = car.isExclusive
            ? `<div class="flex items-center justify-center h-10 px-4 rounded-full text-white font-bold text-sm" style="background: linear-gradient(to right, #C2A55A, #946E20);">–≠–∫—Å–∫–ª—é–∑–∏–≤</div>`
            : '';
            
        let leasingBlockHTML = '';
        if (car.vatStatus === '—Å –ù–î–° 20%') {
            leasingBlockHTML = `
            <div class="mt-8 p-6 bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl text-white text-center shadow-lg">
                <h3 class="text-xl font-bold mb-2">–≠—Ç–æ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –õ–∏–∑–∏–Ω–≥</h3>
                <p class="text-gray-300 mb-4 text-sm max-w-xs mx-auto">–ü–æ–ª—É—á–∏—Ç–µ –≤—ã–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç –Ω–∞—à–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤.</p>
                <button data-action="call" class="inline-block px-8 py-3 bg-white text-gray-900 text-base font-bold rounded-full hover:bg-gray-200 transition-transform transform active:scale-95">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
            </div>
            `;
        }


        return `
            <div class="pb-8">
                <div class="flex justify-between items-center mb-6">
                    <button data-action="back-to-list" class="flex items-center gap-2 text-gray-800 hover:text-black font-medium transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        <span>–ù–∞–∑–∞–¥</span>
                    </button>
                    <div class="flex items-center gap-2">
                        ${exclusiveBadgeHTML}
                        <button data-action="share-detail" data-car-id="${car.id}" class="bg-black text-white rounded-full p-2.5 hover:bg-gray-800 transition-colors" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" /></svg>
                        </button>
                    </div>
                </div>
                
                <div class="relative w-full aspect-[16/10] bg-gray-100 rounded-3xl overflow-hidden mb-6 cursor-grab active:cursor-grabbing" data-swipeable-id="${car.id}">
                    ${imagesHTML}
                    ${imageNavButtonsHTML}
                </div>

                <div class="px-1 sm:px-2">
                     <div class="mb-6 text-left">
                        <p class="text-sm font-bold text-gray-700">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ç–∞–º–æ–∂–Ω—è –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–§ | –ü–æ–ª–Ω—ã–π –ù–î–° 20% | –ü—Ä–æ–¥–∞–∂–∞ –æ—Ç –∏–º–ø–æ—Ä—Ç–µ—Ä–∞</p>
                        <p class="mt-1 text-xs text-gray-500">–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º ‚Äú—Å–µ—Ä—ã–µ‚Äù —Å—Ö–µ–º—ã —Ç–∞–º–æ–∂–Ω–∏ (–ë–µ–ª–æ—Ä—É—Å—Å–∏—è, –ö–∏—Ä–≥–∏–∑–∏—è), –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç —Ä–∏—Å–∫–∏ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è, —á—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç –Ω–∞—Å –æ—Ç 90% –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–æ–≤ –≤ –†–æ—Å—Å–∏–∏.</p>
                    </div>

                    <div class="mb-4 flex items-center gap-2">
                        <div class="inline-block text-sm font-bold px-5 py-2 rounded-full ${availabilityClass}">${car.availability}</div>
                        ${car.vatStatus ? `<div class="inline-block text-sm font-bold px-5 py-2 rounded-full bg-gray-200 text-gray-800">${car.vatStatus}</div>` : ''}
                    </div>

                    <div class="mb-4">
                        ${priceBlockHTML}
                    </div>

                    <h1 class="text-2xl font-bold text-gray-900 mb-6">${car.name}</h1>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <button data-action="call" class="w-full h-14 bg-black text-white text-base font-bold rounded-full hover:bg-gray-800 transition-all transform active:scale-95 flex items-center justify-center">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                        <a href="https://t.me/Gate_phone" target="_blank" class="w-full h-14 bg-gray-200 text-gray-800 text-base font-bold rounded-full hover:bg-gray-300 transition-all transform active:scale-95 flex items-center justify-center">–ù–∞–ø–∏—Å–∞—Ç—å</a>
                    </div>

                    <div>
                        <h2 class="text-xl font-bold mb-4">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
                        <dl>
                            ${characteristicsHTML}
                        </dl>
                    </div>
                    
                    ${leasingBlockHTML}
                </div>
            </div>
        `;
    };

    const renderLoader = () => `<div class="flex justify-center items-center py-20"><div class="w-12 h-12 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div></div>`;
    
    const renderError = (message) => `
        <div class="text-center py-10 bg-white rounded-2xl shadow-sm max-w-md mx-auto">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫</h3>
            <p class="mt-2 text-sm text-gray-500 px-4">${message}</p>
            <div class="mt-6">
                <button id="retry-btn" class="px-6 py-3 bg-black text-white font-bold rounded-2xl hover:bg-gray-800 transition-colors">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
        </div>`;

    const renderFilters = () => {
        const availabilityOptions = ['–í—Å–µ', ...Array.from(new Set(cars.map(c => c.availability)))];
        availabilityFiltersContainer.innerHTML = availabilityOptions.map(option => `
            <button data-filter="${option}" class="filter-pill px-4 py-2 text-sm font-semibold rounded-full border transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-black ${
                state.activeFilter === option
                ? 'bg-black text-white border-black shadow'
                : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-200 hover:border-gray-300'
            }">${option}</button>
        `).join('');
        
        // Update exclusive button style
        const isExclusiveActive = state.activeFilter === '–≠–∫—Å–∫–ª—é–∑–∏–≤';
        exclusiveToggleBtn.innerHTML = isExclusiveActive ? starIconActiveSVG : starIconInactiveSVG;
        if(isExclusiveActive) {
            exclusiveToggleBtn.className = 'w-10 h-10 flex items-center justify-center rounded-full text-white transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-yellow-500';
            exclusiveToggleBtn.style.background = 'linear-gradient(to right, #D1B76D, #8D6516)';
            exclusiveToggleBtn.style.borderColor = 'transparent';

        } else {
            exclusiveToggleBtn.className = 'w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:bg-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-black';
            exclusiveToggleBtn.style.background = '';
            exclusiveToggleBtn.style.borderColor = '';
        }

        const brandOptions = ['–í—Å–µ –±—Ä–µ–Ω–¥—ã', ...Array.from(new Set(cars.map(car => car.brand)))];
        brandSelect.innerHTML = brandOptions.map(brand => `<option value="${brand}" ${state.selectedBrand === brand ? 'selected' : ''}>${brand}</option>`).join('');
    };

    const setupObserver = () => {
        if (observer) {
            observer.disconnect();
        }

        const gridContainer = contentArea.querySelector(':scope > .grid');
        if (!gridContainer || gridContainer.children.length === 0 || state.renderedItemsCount >= filteredCarsCache.length) {
            return; // Nothing to observe or all items are loaded
        }
        
        const lastCard = gridContainer.lastElementChild;
        if (lastCard) {
            observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    observer.disconnect(); // Disconnect to avoid multiple triggers
                    loadMoreItems();
                }
            }, { rootMargin: '400px' }); // Load when user is 400px away from the end

            observer.observe(lastCard);
        }
    };

    const loadMoreItems = () => {
        if (state.loading || state.currentView !== 'list') return;

        const currentCount = state.renderedItemsCount;
        const newCount = Math.min(currentCount + state.itemsPerLoad, filteredCarsCache.length);

        if (newCount > currentCount) {
            const newItems = filteredCarsCache.slice(currentCount, newCount);
            const gridContainer = contentArea.querySelector(':scope > .grid');
            if (gridContainer) {
                const cardRenderer = state.gridLayout === 'grid' ? createCarCardGridHTML : createCarCardHTML;
                const newCardsHTML = newItems.map(cardRenderer).join('');
                gridContainer.insertAdjacentHTML('beforeend', newCardsHTML);
                state.renderedItemsCount = newCount;
            }
        }
        
        setupObserver(); // Re-attach observer to the new last element
    };


    const renderApp = (isFullReRender = false) => {
        if (state.loading) {
            if (observer) observer.disconnect();
            listContainer.classList.remove('hidden');
            detailContainer.classList.add('hidden');
            contentArea.innerHTML = renderLoader();
            return;
        }
        if (state.error) {
            if (observer) observer.disconnect();
            listContainer.classList.remove('hidden');
            detailContainer.classList.add('hidden');
            contentArea.innerHTML = renderError(state.error);
            document.getElementById('retry-btn')?.addEventListener('click', () => {
                state.renderedItemsCount = 20;
                const urlParams = new URLSearchParams(window.location.search);
                const carIdFromUrl = urlParams.get('car');
                fetchAndParseCars(carIdFromUrl);
            });
            return;
        }

        if (state.currentView === 'detail') {
            if (observer) observer.disconnect();
            listContainer.classList.add('hidden');
            detailContainer.classList.remove('hidden');
            const car = cars.find(c => c.id === state.selectedCarId);
            if (car) {
                detailContainer.innerHTML = createCarDetailHTML(car);
            } else {
                // If car not found (e.g., from an old link), go back to list
                state.currentView = 'list';
                state.selectedCarId = null;
                const url = new URL(window.location);
                url.searchParams.delete('car');
                window.history.replaceState({}, '', url); // Use replaceState to not create a bad history entry
                renderApp(true);
            }
            return;
        }
        
        listContainer.classList.remove('hidden');
        detailContainer.classList.add('hidden');
        renderFilters();
        
        if (layoutToggleBtn) {
            layoutToggleBtn.innerHTML = state.gridLayout === 'grid'
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`;
        }
        
        if (isFullReRender) {
            let filtered = cars;
            if (state.searchTerm) {
                filtered = filtered.filter(car => car.name.toLowerCase().includes(state.searchTerm.toLowerCase()));
            }

            if (state.activeFilter === '–≠–∫—Å–∫–ª—é–∑–∏–≤') {
                filtered = filtered.filter(car => car.isExclusive);
            } else if (state.activeFilter !== '–í—Å–µ') {
                filtered = filtered.filter(car => car.availability === state.activeFilter);
            }

            if (state.selectedBrand !== '–í—Å–µ –±—Ä–µ–Ω–¥—ã') {
                filtered = filtered.filter(car => car.brand === state.selectedBrand);
            }

            const availabilityOrder = { '–í –Ω–∞–ª–∏—á–∏–∏': 0, '–í –ø—É—Ç–∏': 1 };
            const getAvailabilityRank = (car) => availabilityOrder[car.availability] ?? 2;

            filtered.sort((a, b) => {
                const rankA = getAvailabilityRank(a);
                const rankB = getAvailabilityRank(b);

                if (rankA !== rankB) {
                    return rankA - rankB;
                }

                switch (state.sortOrder) {
                    case 'price-asc': return (a.finalDiscountPrice ?? a.finalPrice) - (b.finalDiscountPrice ?? b.finalPrice);
                    case 'price-desc': return (b.finalDiscountPrice ?? b.finalPrice) - (a.finalDiscountPrice ?? a.finalPrice);
                    default: return a.name.localeCompare(b.name, 'ru');
                }
            });
            filteredCarsCache = filtered;
        }

        if (filteredCarsCache.length === 0) {
            if (observer) observer.disconnect();
            contentArea.innerHTML = `<div class="text-center py-10"><p class="text-gray-500 text-lg">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>`;
        } else {
             if (isFullReRender) {
                const itemsToRender = filteredCarsCache.slice(0, state.renderedItemsCount);
                const cardRenderer = state.gridLayout === 'grid' ? createCarCardGridHTML : createCarCardHTML;
                const cardsHTML = itemsToRender.map(cardRenderer).join('');
                
                const gridLayoutClasses = state.gridLayout === 'grid'
                    ? 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4'
                    : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-12 gap-x-6';
                
                if (observer) observer.disconnect();
                contentArea.innerHTML = `<div class="${gridLayoutClasses}">${cardsHTML}</div>`;
            }
            setupObserver();
        }
    };
    // --- END OF RENDERING LOGIC ---
    
    // --- START OF HANDLERS ---
    const handleCallAction = () => {
        if (window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initData) {
            const callUrl = new URL('call.html', window.location.href).toString();
            Telegram.WebApp.openLink(callUrl);
        } else {
            window.open('./call.html', '_blank');
        }
    };
    
    // START: Swipe Handlers
    let touchStartTarget = null;
    let touchStartX = 0;
    let touchStartY = 0;

    const handleTouchStart = (e) => {
        const swipeable = e.target.closest('[data-swipeable-id]');
        if (swipeable) {
            touchStartTarget = swipeable;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
    };

    const handleTouchEnd = (e) => {
        if (!touchStartTarget) return;

        const carId = touchStartTarget.dataset.swipeableId;
        const car = cars.find(c => c.id === carId);

        if (!car || car.images.length <= 1 || !e.changedTouches[0]) {
            touchStartTarget = null;
            return;
        }

        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        const swipeThreshold = 40;

        if (Math.abs(deltaX) > swipeThreshold && Math.abs(deltaX) > Math.abs(deltaY)) {
            if (deltaX < 0) { // Swiped left
                car.currentImageIndex = (car.currentImageIndex + 1) % car.images.length;
            } else { // Swiped right
                car.currentImageIndex = (car.currentImageIndex - 1 + car.images.length) % car.images.length;
            }
            
            const imgElement = touchStartTarget.querySelector('img');
            if (imgElement) {
                imgElement.src = car.images[car.currentImageIndex];
            }
        }
        
        touchStartTarget = null;
    };
    // END: Swipe Handlers
    // --- END OF HANDLERS ---

    // --- START OF EVENT LISTENERS ---
    searchInput.addEventListener('input', (e) => {
        state.searchTerm = e.target.value;
        clearSearchBtn.classList.toggle('hidden', !state.searchTerm);
        state.renderedItemsCount = 20;
        renderApp(true);
    });

    clearSearchBtn.addEventListener('click', () => {
        state.searchTerm = '';
        searchInput.value = '';
        clearSearchBtn.classList.add('hidden');
        state.renderedItemsCount = 20;
        renderApp(true);
    });

    availabilityFiltersContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-pill')) {
            state.activeFilter = e.target.dataset.filter;
            state.renderedItemsCount = 20;
            renderApp(true);
        }
    });
    
    exclusiveToggleBtn.addEventListener('click', () => {
        state.activeFilter = state.activeFilter === '–≠–∫—Å–∫–ª—é–∑–∏–≤' ? '–í—Å–µ' : '–≠–∫—Å–∫–ª—é–∑–∏–≤';
        state.renderedItemsCount = 20;
        renderApp(true);
    });

    brandSelect.addEventListener('change', (e) => {
        state.selectedBrand = e.target.value;
        state.renderedItemsCount = 20;
        renderApp(true);
    });

    sortSelect.addEventListener('change', (e) => {
        state.sortOrder = e.target.value;
        state.renderedItemsCount = 20;
        renderApp(true);
    });

    layoutToggleBtn.addEventListener('click', () => {
        state.gridLayout = state.gridLayout === 'grid' ? 'list' : 'grid';
        state.renderedItemsCount = 20;
        renderApp(true);
    });

    contentArea.addEventListener('click', (e) => {
        const actionTarget = e.target.closest('[data-action]');
        if (!actionTarget) return;

        const action = actionTarget.dataset.action;
        const carId = actionTarget.dataset.carId;

        if (action === 'details') {
            e.stopPropagation();
            state.currentView = 'detail';
            state.selectedCarId = carId;

            const url = new URL(window.location);
            url.searchParams.set('car', carId);
            window.history.pushState({ carId: carId }, '', url);

            window.scrollTo(0, 0);
            renderApp();
        } else if (action === 'share') {
            e.stopPropagation();
            const car = cars.find(c => c.id === carId);
            if (car) shareCar(car);
        }
    });
    
    detailContainer.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;

        const action = button.dataset.action;

        if (action === 'call') {
            handleCallAction();
            return;
        }
        
        if (action === 'back-to-list') {
            state.currentView = 'list';
            state.selectedCarId = null;
            
            const url = new URL(window.location);
            url.searchParams.delete('car');
            window.history.pushState({}, '', url);

            renderApp(true);
            return;
        }
        
        const carId = button.dataset.carId;
        const car = cars.find(c => c.id === carId);
        if (!car) return;
        
        if (action === 'prev-image' || action === 'next-image') {
            if (car.images.length <= 1) return;

            if (action === 'prev-image') {
                car.currentImageIndex = (car.currentImageIndex - 1 + car.images.length) % car.images.length;
            } else { // next-image
                car.currentImageIndex = (car.currentImageIndex + 1) % car.images.length;
            }

            const imageContainer = detailContainer.querySelector(`[data-swipeable-id="${carId}"]`);
            if (imageContainer) {
                const imgElement = imageContainer.querySelector('img');
                if (imgElement) {
                    imgElement.src = car.images[car.currentImageIndex];
                }
            }
            return;
        }

        if (action === 'share-detail') {
            shareCar(car);
        }
    });
    
    window.addEventListener('popstate', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const carIdFromUrl = urlParams.get('car');

        if (cars.length === 0) {
            window.location.reload();
            return;
        }

        if (carIdFromUrl) {
            const carExists = cars.some(c => c.id === carIdFromUrl);
            if (carExists) {
                state.currentView = 'detail';
                state.selectedCarId = carIdFromUrl;
            } else {
                state.currentView = 'list';
                state.selectedCarId = null;
                const url = new URL(window.location);
                url.searchParams.delete('car');
                window.history.replaceState({}, '', url);
            }
        } else {
            state.currentView = 'list';
            state.selectedCarId = null;
        }
        renderApp(true);
    });

    contentArea.addEventListener('touchstart', handleTouchStart, { passive: true });
    contentArea.addEventListener('touchend', handleTouchEnd);
    detailContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
    detailContainer.addEventListener('touchend', handleTouchEnd);

    const callButton = document.getElementById('call-button');
    if (callButton) {
        callButton.addEventListener('click', (e) => {
            e.preventDefault();
            handleCallAction();
        });
    }
    // --- END OF EVENT LISTENERS ---
    
    // --- START INITIAL LOAD ---
    const urlParams = new URLSearchParams(window.location.search);
    const carIdFromUrl = urlParams.get('car');

    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready();
    }
    
    document.querySelector('footer p').innerHTML = `&copy; ${new Date().getFullYear()} Gate Automobile. –ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.`;
    fetchAndParseCars(carIdFromUrl);
    // --- END INITIAL LOAD ---
});
</script>
</body>
</html>